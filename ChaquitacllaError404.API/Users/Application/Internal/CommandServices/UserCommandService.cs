using System.IdentityModel.Tokens.Jwt;
using System.Security.Claims;
using System.Text;
using ChaquitacllaError404.API.Shared.Infrastructure.Persistence.EFC.Repositories;
using ChaquitacllaError404.API.Users.Domain.Model.Aggregates;
using ChaquitacllaError404.API.Users.Domain.Model.Commands;
using ChaquitacllaError404.API.Users.Domain.Model.ValueObjects;
using ChaquitacllaError404.API.Users.Domain.Repositories;
using Microsoft.IdentityModel.Tokens;

namespace ChaquitacllaError404.API.Users.Application.Internal.CommandServices;

public class UserCommandService(IUserRepository userRepository, UnitOfWork unitOfWork, string _jwtSecret)
//                              , IExternalProfileService externalProfileService (ACL para unir con profiles)
{
    public async Task<User?> Handle(CreateUserCommand command, string firstName, string lastName, string email, int price, string description)
    {
        var user = new User(command);
        user.Password = User.EncryptPassword(command.Password);

        try
        {
            // Creamos el perfil asociado en el contexto profile
            // var profileId = await externalProfileService.CreateProfileAsync(string firstName, string lastName, string email, string subscription);
            //if (profileId == 0)
            //{
            //  throw new Exception("Failed to create profile.");
            //}

            await userRepository.AddAsync(user);
            await unitOfWork.CompleteAsync();                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
            return user;
        }
        catch(Exception e)
        {
            Console.WriteLine($"An error occurred while creating the User: {e.Message}");
            return null;
        }    
    }

    public async Task<string?> Handle(LoginUserCommand command)
    {
        var user = await userRepository.FindByFirstNameAsync(command.FirstName);
        user = await userRepository.FindByLastNameAsync(command.LastName);

        if (user == null)
        {
            Console.WriteLine($"User not found: {command.FirstName} {command.LastName}");
            return null;
        }

        if (!user.VerifyPassword(command.Password))
        {
            Console.WriteLine($"Invalid password for user: {command.FirstName} {command.LastName}");
            return null;
        }
        
        // Generar JWT token

        var tokenHandler = new JwtSecurityTokenHandler();
        var key = Encoding.ASCII.GetBytes(_jwtSecret);
        var tokenDescriptor = new SecurityTokenDescriptor
        {
            Subject = new ClaimsIdentity(new Claim[]
            {
                new Claim(ClaimTypes.Name, user.FirstName + " " + user.LastName),
            }),
            Expires = DateTime.UtcNow.AddHours(1),
            SigningCredentials = new SigningCredentials(new SymmetricSecurityKey(key), SecurityAlgorithms.HmacSha256Signature)
        };
        var token = tokenHandler.CreateToken(tokenDescriptor);
        return tokenHandler.WriteToken(token);
    }

    public async Task<User?> Handle(CreateUserCommand command)
    {
        var user = new User(command);
        try
        {
            await userRepository.AddAsync(user);
            await unitOfWork.CompleteAsync();
            return user;
        } catch(Exception e)
        {
            Console.WriteLine($"An error occurred while creating the User: {e.Message}");
            return null;
        }
    }
}